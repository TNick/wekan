import { JsonRoutes } from 'meteor/simple:json-routes';
import { Authentication } from 'meteor/simple:authenticate-user-by-token';

import { Swimlanes } from '/imports/api/models/swimlanes';


JsonRoutes.add('GET', '/api/boards/:boardId/swimlanes', function (req, res) {
  try {
    const paramBoardId = req.params.boardId;
    Authentication.checkBoardAccess( req.userId, paramBoardId);

    JsonRoutes.sendResult(res, {
      code: 200,
      data: Swimlanes.find({ boardId: paramBoardId, archived: false }).map(function (doc) {
        return {
          _id: doc._id,
          title: doc.title,
        };
      }),
    });
  }
  catch (error) {
    JsonRoutes.sendResult(res, {
      code: 200,
      data: error,
    });
  }
});

JsonRoutes.add('GET', '/api/boards/:boardId/swimlanes/:swimlaneId', function (req, res) {
  try {
    const paramBoardId = req.params.boardId;
    const paramSwimlaneId = req.params.swimlaneId;
    Authentication.checkBoardAccess( req.userId, paramBoardId);
    JsonRoutes.sendResult(res, {
      code: 200,
      data: Swimlanes.findOne({ _id: paramSwimlaneId, boardId: paramBoardId, archived: false }),
    });
  }
  catch (error) {
    JsonRoutes.sendResult(res, {
      code: 200,
      data: error,
    });
  }
});

JsonRoutes.add('POST', '/api/boards/:boardId/swimlanes', function (req, res) {
  try {
    Authentication.checkUserId( req.userId);
    const paramBoardId = req.params.boardId;
    const id = Swimlanes.insert({
      title: req.body.title,
      boardId: paramBoardId,
    });
    JsonRoutes.sendResult(res, {
      code: 200,
      data: {
        _id: id,
      },
    });
  }
  catch (error) {
    JsonRoutes.sendResult(res, {
      code: 200,
      data: error,
    });
  }
});

JsonRoutes.add('DELETE', '/api/boards/:boardId/swimlanes/:swimlaneId', function (req, res) {
  try {
    Authentication.checkUserId( req.userId);
    const paramBoardId = req.params.boardId;
    const paramSwimlaneId = req.params.swimlaneId;
    Swimlanes.remove({ _id: paramSwimlaneId, boardId: paramBoardId });
    JsonRoutes.sendResult(res, {
      code: 200,
      data: {
        _id: paramSwimlaneId,
      },
    });
  }
  catch (error) {
    JsonRoutes.sendResult(res, {
      code: 200,
      data: error,
    });
  }
});
